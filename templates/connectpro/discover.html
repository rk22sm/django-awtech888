{% extends "connectpro/base.html" %}

{% block body_class %}overflow-hidden{% endblock %}

{% block content %}

<main class="ml-3  py-6 overflow-hidden">
    <div class="flex items-center justify-between rounded-2xl border border-emerald-100  bg-green-500/10 to-white px-6 py-4 shadow-sm shadow-emerald-50">
        <div>
          <p class="text-sm font-semibold text-slate-900">Daily Connection Limit</p>
          <p class="text-sm text-slate-600">
            {% if remaining is None %}
              Unlimited connections with your plan
            {% else %}
              You have {{ remaining }} of {{ limit }} connections remaining today
            {% endif %}
          </p>
        </div>
        {% if request.user.membership_plan != "pro" %}
          <a href="{% url 'payments:subscribe' %}?plan=plus" 
             class="inline-flex items-center gap-2  rounded-full px-4 py-2 text-sm font-semibold text-back transition hover:bg-emerald-600">Upgrade Plan</a>
        {% endif %}
      </div>
  <div class="grid h-full gap-6 mt-6 lg:grid-cols-[1.1fr_0.65fr]">
    <div class="flex h-full min-h-0 flex-col space-y-5">
      

      <form method="get" class="flex items-center gap-3 rounded-2xl border border-slate-200 bg-white px-4 py-3 shadow-sm">
        <span class="text-lg text-slate-400">üîç</span>
        <input class="w-full border-0 bg-transparent text-sm text-slate-800 placeholder:text-slate-400 focus:outline-none" type="text" name="q" value="{{ search_query }}" placeholder="Search by name, skills, or location..." />
      </form>

      <div class="flex items-center justify-between">
        <div>
          <p class="text-lg font-semibold   text-back-600">Discover Clients</p>
        </div>
      </div>

      <div class="discover-scroll soft-scrollbar space-y-4 overflow-y-auto pr-2 flex-1 min-h-0">
        {% if users %}
            {% for person in users %}
              <article class="rounded-2xl border border-slate-200 bg-white/90 p-5 shadow-sm transition ">
                <div class="flex items-start justify-between gap-4">
                  <div class="flex items-start gap-4">
                    <div class="h-14 w-14 overflow-hidden rounded-2xl bg-slate-100">
                      {% if person.profile.profile_picture %}
                        <img src="{{ person.profile.profile_picture.url }}" alt="{{ person.username }} photo" class="h-full w-full object-cover">
                      {% else %}
                        <div class="flex h-full w-full items-center justify-center text-lg font-semibold text-slate-500">{{ person.username|slice:":1"|upper }}</div>
                      {% endif %}
                    </div>
                    <div>
                      <div class="text-base font-semibold text-slate-900">{{ person.username }}</div>
                      <div class="text-sm text-slate-600">
                        {{ person.profile.headline|default:"No headline yet" }}
                      </div>
                      {% if person.profile.location %}
                        <div class="text-sm text-slate-500">üìç {{ person.profile.location }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <span class="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-700">{{ person.get_role_display }}</span>
                </div>

                {% if person.profile.skills %}
                  <div class="mt-3 flex flex-wrap gap-2">
                    {% for skill in person.profile.skills %}
                      <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">{{ skill }}</span>
                    {% endfor %}
                  </div>
                {% endif %}

                <div class="mt-4 flex flex-wrap items-center gap-3">
                  {% if person.existing_connection %}
                    {% if person.existing_connection.status == "accepted" %}
                      <span class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-4 py-2 text-sm font-semibold text-emerald-700">Connected</span>
                      <a class="inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-white px-4 py-2 text-sm font-semibold text-emerald-700 transition " href="{% url 'messages:start_chat' person.id%}">Message</a>
                      <a class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition " href="{% url 'connectpro:profile' person.id %}">View Profile</a>
                    {% elif person.existing_connection.status == "pending" and person.connection_direction == "sent" %}
                      <button class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-500" disabled>Pending</button>
                    {% elif person.existing_connection.status == "pending" and person.connection_direction == "received" %}
                      <form method="post" action="{% url 'connectpro:respond_connection' person.existing_connection.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="action" value="accept">
                        <button class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition hover:bg-emerald-600">Accept</button>
                      </form>
                      <form method="post" action="{% url 'connectpro:respond_connection' person.existing_connection.id %}">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <input type="hidden" name="action" value="decline">
                        <button class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-red-200 hover:text-red-600">Decline</button>
                      </form>
                    {% else %}
                      <button class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-500" disabled>{{ person.existing_connection.get_status_display }}</button>
                    {% endif %}
                  {% else %}
                    <form method="post" action="{% url 'connectpro:connect' person.username %}">
                      {% csrf_token %}
                      <button class="inline-flex items-center gap-2 rounded-full bg-emerald-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-emerald-200 transition hover:bg-emerald-600" {% if remaining == 0 %}disabled class="opacity-60"{% endif %}>
                        {% if remaining == 0 %}Limit reached{% else %}Connect{% endif %}
                      </button>
                    </form>
                    <a class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-emerald-200 hover:bg-emerald-50 hover:text-emerald-700" href="{% url 'connectpro:profile_detail' person.id %}">View Profile</a>
                  {% endif %}
                </div>
              </article>
            {% endfor %}
        {% else %}
          <article class="rounded-2xl border border-slate-200 bg-white/80 p-5 text-slate-500">
            No people found for this search.
          </article>
        {% endif %}
      </div>
    </div>

    <aside class="h-full space-y-4 overflow-y-auto pr-2 soft-scrollbar">
      <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm">
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold text-slate-900">My Connections ({{ active_connections|length }})</div>
        </div>

        <div class="mt-4 space-y-3">
          {% for conn in active_connections %}
            {% if conn.from_user == request.user %}
              {% with friend=conn.to_user %}
                <div class="flex items-center justify-between rounded-xl border border-slate-100 px-3 py-2">
                  <div>
                    <div class="text-sm font-semibold text-slate-800">{{ friend.username }}</div>
                    <div class="text-xs text-slate-500">{{ friend.profile.headline|default:friend.get_role_display }}</div>
                  </div>
                  <a class="text-lg" href="{% url 'messages:start_chat' friend.id %}">üí¨</a>
                </div>
              {% endwith %}
            {% else %}
              {% with friend=conn.from_user %}
                <div class="flex items-center justify-between rounded-xl border border-slate-100 px-3 py-2">
                  <div>
                    <div class="text-sm font-semibold text-slate-800">{{ friend.username }}</div>
                    <div class="text-xs text-slate-500">{{ friend.profile.headline|default:friend.get_role_display }}</div>
                  </div>
                  <a class="text-lg" href="{% url 'messages:start_chat' friend.id  %}">üí¨</a>
                </div>
              {% endwith %}
            {% endif %}
          {% empty %}
            <div class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
              No connections yet.
            </div>
          {% endfor %}
        </div>
       <a  class="inline-flex items-center mt-3 justify-center gap-2 whitespace-nowrap text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&amp;_svg]:pointer-events-none [&amp;_svg]:size-4 [&amp;_svg]:shrink-0 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 rounded-md px-3 w-full" href="{% url 'connectpro:discover' %}">View all</a>

      </div>

      <div class="rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm">
        <div class="text-sm font-semibold text-slate-900">Popular Skills</div>
        <div class="mt-3 flex flex-wrap gap-2">
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">React</span>
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">Node.js</span>
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">Python</span>
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">AWS</span>
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">TypeScript</span>
          <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700">Docker</span>
        </div>
      </div>
    </aside>
  </div>
</main>
{% endblock content %}
